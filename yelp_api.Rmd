---
title: "Yelp_API"
author: "Grant Smith"
date: "2/26/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r,message=FALSE}
library(jsonlite)
library(httr)
library(tidyverse)
library(rromeo)
library(plotly)
```


```{r}
yp <- GET(
  "https://api.yelp.com/v3/businesses/search",
  add_headers(Authorization = paste("Bearer", Sys.getenv("MY_YELP"))),
  query = list(
    term="Restaurant",
    location = "Davis, CA 95618", 
    limit=50
    

  )
)
stop_for_status(yp)
json <- content(yp, as = "text",encoding="UTF-8")

fromJSON(json)$business %>% select(coordinates)

rateme<-fromJSON(json)$business %>% select(id,name,rating)

rateme %>% 
  group_by(rating) %>% 
  plot_ly(x=~rating,type='histogram',color=~factor(rating))
```

```{r}
rateme %>% 
  arrange(desc(rating))
```

```{r}
yp_rev<-GET(
  "https://api.yelp.com/v3/businesses/iLNnJRb7zgms4flTf9qteg/reviews",
   add_headers(Authorization = paste("Bearer", Sys.getenv("MY_YELP"))))
stop_for_status(yp_rev)

```

```{r}
usethis::edit_r_environ()
```

```{r}
yp_davis<-fromJSON(json)$business %>% 
 
  select(id, name, image_url,review_count,categories,rating,coordinates,price,location,display_phone, transactions) %>% 
  unnest(categories) %>% 
  mutate(lat = coordinates$lat,lon = coordinates$lon) %>% 
  mutate( display_address = as.character(location$display_address),city=as.character(location$city)) %>% 
  select(name,title,rating,price,display_phone,lat,lon,display_address,city) %>%
   distinct(name,.keep_all = TRUE) 
  


yp_davis %>%  distinct(name,.keep_all = TRUE)
  
      
?filter
yp_davis
```

```{r}
ipc<-"Davis"
ipc_glu<-str_glue(ipc,", CA")

ipc_glu

ypt<-GET(
  "https://api.yelp.com/v3/businesses/search",
  add_headers(Authorization = paste("Bearer", Sys.getenv("MY_YELP"))),
  query = list(
    term="Restaurant",
    location = str_glue(ipc,", CA"), 
    limit=50 
  ))  
stop_for_status(ypt)

json2<-content(ypt,as="text",encoding = "UTF-8")
fromJSON(json2)$business %>% mutate(address=as.character(location$display_address)) %>% 
  select(name,address)
```


```{r}
mode(ipc_glu)

paste(ipc,", CA")
```

